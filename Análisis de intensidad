import asyncio
import httpx
import json
import re
from tqdm import tqdm

API_KEY = "tu_api_key"  # <-- Sustituye con tu clave real
API_URL = "https://api.deepseek.com/v1/chat/completions"
MODELO = "deepseek-chat"
INPUT_PATH = "resultados/frases_contexto.json"
OUTPUT_PATH = "resultados/analisis_intensidad.json"

async def analizar_intensidad(frase: str):
    prompt = f"""
Analiza la siguiente frase, identificando:

1. La etapa del proceso cientÃ­fico a la que se refiere, elije solo una:
- "DefiniciÃ³n del problema"
- "DiseÃ±o metodolÃ³gico"
- "RecolecciÃ³n de datos"
- "AnÃ¡lisis de datos"
- "InterpretaciÃ³n de resultados"
- "Toma de decisiones"
- "ComunicaciÃ³n de resultados"

2. El nivel de participaciÃ³n ciudadana, segÃºn esta clasificaciÃ³n:

- No hay participaciÃ³n 

- Contributivo (ParticipaciÃ³n mÃ­nima): 
    CiudadanÃ­a: Recolecta datos, observa, aporta puntualmente.
    CientÃ­fico/a: DiseÃ±a y controla todo el anÃ¡lisis.
    Ejemplo: â€œLos ciudadanos enviaban fotos mediante una app.â€

- Colaborativo (ParticipaciÃ³n consultiva):
    CiudadanÃ­a: Aporta datos y colabora en anÃ¡lisis bÃ¡sicos.
    CientÃ­fico/a: Supervisa con retroalimentaciÃ³n parcial.   
    Ejemplo: â€œLos participantes ayudaron a ajustar el protocolo de muestreo.â€

- Co-creativo (ParticipaciÃ³n colaborativa):
    CiudadanÃ­a: Participa en el diseÃ±o, metodologÃ­a, y anÃ¡lisis.
    CientÃ­fico/a: ActÃºa como socio y facilitador.
    Ejemplo: â€œLa comunidad definiÃ³ las preguntas junto al equipo cientÃ­fico.â€

- Liderado por la ciudadanÃ­a (ParticipaciÃ³n plena):
    CiudadanÃ­a: Lidera el proyecto, toma decisiones, coordina.
    CientÃ­fico/a: Apoya como asesor tÃ©cnico si es necesario.
    Ejemplo: â€œEl colectivo vecinal diseÃ±Ã³ y gestionÃ³ el proyecto de monitoreo.â€

3. Asigna un score de 0 a 4:
- 0 = No hay participaciÃ³n 
- 1 = Contributivo
- 2 = Colaborativo
- 3 = Co-creativo
- 4 = Liderado por la ciudadanÃ­a

Frase:
"{frase}"

Devuelve un JSON con esta estructura:

{{
  "etapa": "...",
  "nivel": "...",
  "score": 0,
  "evidencia": "..."
}}
"""
    headers = {
        "Authorization": f"Bearer {API_KEY}",
        "Content-Type": "application/json"
    }

    payload = {
        "model": MODELO,
        "messages": [
            {"role": "system", "content": "Eres un experto en participaciÃ³n ciudadana en ciencia."},
            {"role": "user", "content": prompt}
        ],
        "temperature": 0.1,
        "max_tokens": 500
    }

    async with httpx.AsyncClient(timeout=90.0) as client:
        r = await client.post(API_URL, headers=headers, json=payload)
        r.raise_for_status()
        content = r.json()["choices"][0]["message"]["content"]
        match = re.search(r'\{.*\}', content, re.DOTALL)
        if match:
            return json.loads(match.group())
        else:
            return {"error": "No se pudo extraer JSON de la respuesta"}

async def ejecutar_analisis_intensidad():
    with open(INPUT_PATH, "r", encoding="utf-8") as f:
        documentos = json.load(f)

    for doc in documentos:
        print(f"\nðŸ“„ Analizando INTENSIDAD en: {doc['archivo']}")
        for frase_data in tqdm(doc["frases_contextualizadas"], desc="Intensidad"):
            if frase_data["tipo"] == "intensidad" and frase_data["requiere_contexto"] is False:
                try:
                    resultado = await analizar_intensidad(frase_data["frase"])
                    frase_data["resultado"] = resultado
                except Exception as e:
                    frase_data["resultado"] = {"error": str(e)}

    with open(OUTPUT_PATH, "w", encoding="utf-8") as f:
        json.dump(documentos, f, indent=2, ensure_ascii=False)

    print(f"\nâœ… AnÃ¡lisis de intensidad completado â†’ {OUTPUT_PATH}")

if __name__ == "__main__":
    asyncio.run(ejecutar_analisis_intensidad())

